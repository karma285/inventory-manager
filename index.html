<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¬ê³ ê´€ë¦¬ + ë°”ì½”ë“œ ìŠ¤ìº” (jsQR ì‚¬ìš©)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    h1 {
        text-align: center;
        color: #333;
    }
    .input-group {
        margin-bottom: 10px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }
    button {
        padding: 10px;
        width: 100%;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 5px;
    }
    button:hover {
        background-color: #45a049;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    .delete-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
    }
    .delete-btn:hover {
        background-color: #c0392b;
    }
    #video {
        width: 100%;
        max-width: 400px;
        border: 1px solid #ccc;
        margin-top: 20px;
    }
    #canvas {
        display: none;
    }
    #scanStatus {
        margin-top: 10px;
        font-weight: bold;
        color: #555;
        text-align: center;
    }
</style>
</head>
<body>

<h1>ğŸ“¦ ì¬ê³ ê´€ë¦¬ í”„ë¡œê·¸ë¨ + ë°”ì½”ë“œ ìŠ¤ìº” (jsQR)</h1>

<div class="input-group">
    <label for="productName">ìƒí’ˆëª…</label>
    <input type="text" id="productName" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
</div>
<div class="input-group">
    <label for="productQuantity">ìˆ˜ëŸ‰</label>
    <input type="number" id="productQuantity" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" />
</div>
<div class="input-group">
    <label for="productBarcode">ë°”ì½”ë“œ ë²ˆí˜¸</label>
    <input type="text" id="productBarcode" placeholder="ë°”ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
</div>
<button id="addButton">ìƒí’ˆ ì¶”ê°€</button>
<button id="startScanButton">ë°”ì½”ë“œ ìŠ¤ìº” ì‹œì‘</button>
<button id="stopScanButton" style="display:none; background-color:#e67e22;">ìŠ¤ìº” ì¤‘ì§€</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="scanStatus">ìŠ¤ìº” ëŒ€ê¸° ì¤‘...</div>

<table>
    <thead>
        <tr>
            <th>ìƒí’ˆëª…</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ë°”ì½”ë“œ</th>
            <th>ì‚­ì œ</th>
        </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
</table>

<!-- jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];

const productNameInput = document.getElementById('productName');
const productQuantityInput = document.getElementById('productQuantity');
const productBarcodeInput = document.getElementById('productBarcode');
const addButton = document.getElementById('addButton');
const inventoryTable = document.getElementById('inventoryTable');

const startScanButton = document.getElementById('startScanButton');
const stopScanButton = document.getElementById('stopScanButton');
const scanStatus = document.getElementById('scanStatus');

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let scanning = false;
let scanInterval;
let videoStream = null;

function renderInventory() {
    inventoryTable.innerHTML = '';

    if (inventory.length === 0) {
        inventoryTable.innerHTML = `<tr><td colspan="4">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
    }

    inventory.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.barcode}</td>
            <td><button class="delete-btn" data-index="${index}">ì‚­ì œ</button></td>
        `;
        inventoryTable.appendChild(tr);
    });

    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', e => {
            const idx = e.target.getAttribute('data-index');
            deleteItem(idx);
        });
    });
}

function addItem() {
    const name = productNameInput.value.trim();
    const quantity = productQuantityInput.value.trim();
    const barcode = productBarcodeInput.value.trim();

    if (!name || !quantity || !barcode) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    if (isNaN(quantity) || quantity <= 0) {
        alert('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    inventory.push({ name, quantity: Number(quantity), barcode });
    localStorage.setItem('inventory', JSON.stringify(inventory));

    productNameInput.value = '';
    productQuantityInput.value = '';
    productBarcodeInput.value = '';

    renderInventory();
}

function deleteItem(index) {
    inventory.splice(index, 1);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderInventory();
}

addButton.addEventListener('click', addItem);

renderInventory();

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        scanning = true;
        scanStatus.textContent = "ìŠ¤ìº” ì¤‘...";

        scanInterval = requestAnimationFrame(scanFrame);
    } catch (e) {
        alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•˜ê±°ë‚˜ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e.message);
    }
}

function stopCamera() {
    scanning = false;
    scanStatus.textContent = "ìŠ¤ìº” ì¤‘ì§€";

    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    cancelAnimationFrame(scanInterval);
}

function scanFrame() {
    if (!scanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
            productBarcodeInput.value = code.data;
            scanStatus.textContent = `ë°”ì½”ë“œ ì¸ì‹: ${code.data}`;

            if (!productNameInput.value.trim()) productNameInput.value = "ìŠ¤ìº”ìƒí’ˆ";
            if (!productQuantityInput.value.trim()) productQuantityInput.value = "1";

            addItem();
            stopScanButton.click(); // ìë™ ì¤‘ì§€
            return;
        } else {
            scanStatus.textContent = "ìŠ¤ìº” ì¤‘...";
        }
    }

    scanInterval = requestAnimationFrame(scanFrame);
}

startScanButton.addEventListener('click', () => {
    startScanButton.style.display = 'none';
    stopScanButton.style.display = 'inline-block';
    startCamera();
});

stopScanButton.addEventListener('click', () => {
    stopScanButton.style.display = 'none';
    startScanButton.style.display = 'inline-block';
    stopCamera();
});
</script>

</body>
</html>
