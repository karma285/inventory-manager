<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>재고관리 + 바코드 스캔</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    h1 {
        text-align: center;
        color: #333;
    }
    .input-group {
        margin-bottom: 10px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }
    button {
        padding: 10px;
        width: 100%;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 5px;
    }
    button:hover {
        background-color: #45a049;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    .delete-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
    }
    .delete-btn:hover {
        background-color: #c0392b;
    }
    #reader {
        width: 100%;
        margin-top: 20px;
        min-height: 250px;
        border: 1px solid #ddd;
    }
    #stopScanButton {
        background-color: #e67e22;
        margin-top: 5px;
        display: none;
    }
</style>
</head>
<body>

<h1>📦 재고관리 프로그램 + 바코드 스캔</h1>

<div class="input-group">
    <label for="productName">상품명</label>
    <input type="text" id="productName" placeholder="상품명을 입력하세요" />
</div>
<div class="input-group">
    <label for="productQuantity">수량</label>
    <input type="number" id="productQuantity" placeholder="수량을 입력하세요" />
</div>
<div class="input-group">
    <label for="productBarcode">바코드 번호</label>
    <input type="text" id="productBarcode" placeholder="바코드 번호를 입력하세요" />
</div>
<button id="addButton">상품 추가</button>
<button id="startScanButton">바코드 스캔 시작</button>
<button id="stopScanButton">스캔 중지</button>

<div id="reader"></div>

<table>
    <thead>
        <tr>
            <th>상품명</th>
            <th>수량</th>
            <th>바코드</th>
            <th>삭제</th>
        </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
</table>

<!-- html5-qrcode 라이브러리 -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];

const productNameInput = document.getElementById('productName');
const productQuantityInput = document.getElementById('productQuantity');
const productBarcodeInput = document.getElementById('productBarcode');
const addButton = document.getElementById('addButton');
const inventoryTable = document.getElementById('inventoryTable');

const startScanButton = document.getElementById('startScanButton');
const stopScanButton = document.getElementById('stopScanButton');
const readerDiv = document.getElementById('reader');

let html5QrcodeScanner = null;

function renderInventory() {
    inventoryTable.innerHTML = '';

    if (inventory.length === 0) {
        inventoryTable.innerHTML = `<tr><td colspan="4">등록된 상품이 없습니다.</td></tr>`;
        return;
    }

    inventory.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.barcode}</td>
            <td><button class="delete-btn" data-index="${index}">삭제</button></td>
        `;
        inventoryTable.appendChild(tr);
    });

    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', e => {
            const idx = e.target.getAttribute('data-index');
            deleteItem(idx);
        });
    });
}

function addItem() {
    const name = productNameInput.value.trim();
    const quantity = productQuantityInput.value.trim();
    const barcode = productBarcodeInput.value.trim();

    if (!name || !quantity || !barcode) {
        alert('모든 항목을 입력해주세요.');
        return;
    }
    if (isNaN(quantity) || quantity <= 0) {
        alert('수량은 1 이상의 숫자여야 합니다.');
        return;
    }

    inventory.push({ name, quantity: Number(quantity), barcode });
    localStorage.setItem('inventory', JSON.stringify(inventory));

    productNameInput.value = '';
    productQuantityInput.value = '';
    productBarcodeInput.value = '';

    renderInventory();
}

function deleteItem(index) {
    inventory.splice(index, 1);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderInventory();
}

addButton.addEventListener('click', addItem);

renderInventory();

startScanButton.addEventListener('click', () => {
    if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("reader");
    }

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            const backCamera = cameras.find(cam => /back|rear|environment/gi.test(cam.label)) || cameras[0];

            startScanButton.style.display = 'none';
            stopScanButton.style.display = 'inline-block';

            html5QrcodeScanner.start(
                backCamera.id,
                {
                    fps: 10,
                    qrbox: 250,
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.CODE_93,
                        Html5QrcodeSupportedFormats.QR_CODE
                    ]
                },
                (decodedText, decodedResult) => {
                    productBarcodeInput.value = decodedText;

                    if (!productNameInput.value.trim()) productNameInput.value = "스캔상품";
                    if (!productQuantityInput.value.trim()) productQuantityInput.value = "1";

                    addItem();
                    stopScanButton.click(); // 자동 중지
                },
                errorMessage => {
                    // 스캔 에러 무시
                }
            ).catch(err => {
                alert("카메라 시작 실패: " + err);
                resetScanButtons();
            });
        } else {
            alert("카메라를 찾을 수 없습니다.");
        }
    }).catch(err => {
        alert("카메라 접근 오류: " + err);
    });
});

stopScanButton.addEventListener('click', () => {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            resetScanButtons();
        }).catch(err => {
            alert("스캔 중지 실패: " + err);
        });
    } else {
        resetScanButtons();
    }
});

function resetScanButtons() {
    startScanButton.style.display = 'inline-block';
    stopScanButton.style.display = 'none';
}
</script>

</body>
</html>
