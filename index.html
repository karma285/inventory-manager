<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>바코드 스캔 + 재고관리</title>
<style>
  body { font-family: Arial, sans-serif; max-width:600px; margin:auto; padding:20px; background:#f5f5f5; }
  h1 { text-align:center; color:#333; }
  input, button { width:100%; padding:10px; margin:5px 0; box-sizing:border-box; }
  #cameraArea { width: 100%; border:1px solid #ccc; margin-top:10px; height: 0; overflow: hidden; }
  table { width:100%; border-collapse: collapse; margin-top:20px; background:#fff; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#4CAF50; color:#fff; }
  .delete-btn { background:#e74c3c; color:#fff; border:none; padding:5px 10px; cursor:pointer; }
  .delete-btn:hover { background:#c0392b; }
</style>
</head>
<body>

<h1>📦 바코드 스캔 + 재고관리</h1>

<button id="startCameraBtn">카메라 켜기 (모바일)</button>

<div id="cameraArea"></div>

<div>
  <label>상품명</label>
  <input type="text" id="productName" placeholder="상품명을 입력하세요" />
  <label>수량</label>
  <input type="number" id="productQuantity" placeholder="수량을 입력하세요" />
  <label>바코드 번호</label>
  <input type="text" id="productBarcode" placeholder="바코드 번호를 입력하세요" />
  <button id="addButton">상품 추가</button>
</div>

<table>
  <thead>
    <tr><th>상품명</th><th>수량</th><th>바코드</th><th>삭제</th></tr>
  </thead>
  <tbody id="inventoryTable"></tbody>
</table>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  const startCameraBtn = document.getElementById('startCameraBtn');
  const cameraArea = document.getElementById('cameraArea');

  const productNameInput = document.getElementById('productName');
  const productQuantityInput = document.getElementById('productQuantity');
  const productBarcodeInput = document.getElementById('productBarcode');
  const addButton = document.getElementById('addButton');
  const inventoryTable = document.getElementById('inventoryTable');

  let inventory = JSON.parse(localStorage.getItem('inventory')) || [];

  let html5QrcodeScanner = null;

  function renderInventory(){
    inventoryTable.innerHTML = '';
    if(inventory.length === 0){
      inventoryTable.innerHTML = '<tr><td colspan="4">등록된 상품이 없습니다.</td></tr>';
      return;
    }
    inventory.forEach((item, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.quantity}</td>
        <td>${item.barcode}</td>
        <td><button class="delete-btn" data-idx="${idx}">삭제</button></td>
      `;
      inventoryTable.appendChild(tr);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = e => {
        const idx = e.target.getAttribute('data-idx');
        inventory.splice(idx, 1);
        localStorage.setItem('inventory', JSON.stringify(inventory));
        renderInventory();
      }
    });
  }

  function addItem(name, quantity, barcode){
    if(!name || !quantity || !barcode){
      alert('모든 항목을 입력해주세요.');
      return false;
    }
    if(isNaN(quantity) || quantity <= 0){
      alert('수량은 1 이상의 숫자여야 합니다.');
      return false;
    }
    inventory.push({name, quantity: Number(quantity), barcode});
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderInventory();
    return true;
  }

  addButton.onclick = () => {
    if(addItem(productNameInput.value.trim(), productQuantityInput.value.trim(), productBarcodeInput.value.trim())){
      productNameInput.value = '';
      productQuantityInput.value = '';
      productBarcodeInput.value = '';
    }
  };

  startCameraBtn.onclick = async () => {
    if(!isMobile){
      alert('모바일에서만 지원됩니다.');
      return;
    }

    try {
      if(html5QrcodeScanner){
        await html5QrcodeScanner.stop();
        await html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
      }

      html5QrcodeScanner = new Html5Qrcode("cameraArea");

      const cameras = await Html5Qrcode.getCameras();
      if(cameras && cameras.length){
        const backCamera = cameras.find(cam => /back|rear|environment/i.test(cam.label)) || cameras[0];

        cameraArea.style.height = '300px';
        startCameraBtn.style.display = 'none';

        await html5QrcodeScanner.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            productBarcodeInput.value = decodedText;
            if(!productNameInput.value.trim()) productNameInput.value = '스캔상품';
            if(!productQuantityInput.value.trim()) productQuantityInput.value = '1';

            addItem(productNameInput.value, productQuantityInput.value, productBarcodeInput.value);

            html5QrcodeScanner.stop().then(() => {
              html5QrcodeScanner.clear();
              html5QrcodeScanner = null;
              cameraArea.style.height = '0';
              startCameraBtn.style.display = 'inline-block';
            });
          },
          (error) => {
            // 스캔 실패시 에러 무시 가능
            console.log('Scan error:', error);
          }
        );
      } else {
        alert('카메라를 찾을 수 없습니다.');
      }
    } catch (error) {
      alert('카메라 실행 오류: ' + error);
      cameraArea.style.height = '0';
      startCameraBtn.style.display = 'inline-block';
    }
  };

  renderInventory();
});
</script>

</body>
</html>
