<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>재고관리 + 바코드 스캔 (jsQR 사용)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    h1 {
        text-align: center;
        color: #333;
    }
    .input-group {
        margin-bottom: 10px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }
    button {
        padding: 10px;
        width: 100%;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 5px;
    }
    button:hover {
        background-color: #45a049;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    .delete-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
    }
    .delete-btn:hover {
        background-color: #c0392b;
    }
    #video {
        width: 100%;
        max-width: 400px;
        border: 1px solid #ccc;
        margin-top: 20px;
    }
    #canvas {
        display: none;
    }
    #scanStatus {
        margin-top: 10px;
        font-weight: bold;
        color: #555;
        text-align: center;
    }
</style>
</head>
<body>

<h1>📦 재고관리 프로그램 + 바코드 스캔 (jsQR)</h1>

<div class="input-group">
    <label for="productName">상품명</label>
    <input type="text" id="productName" placeholder="상품명을 입력하세요" />
</div>
<div class="input-group">
    <label for="productQuantity">수량</label>
    <input type="number" id="productQuantity" placeholder="수량을 입력하세요" />
</div>
<div class="input-group">
    <label for="productBarcode">바코드 번호</label>
    <input type="text" id="productBarcode" placeholder="바코드 번호를 입력하세요" />
</div>
<button id="addButton">상품 추가</button>
<button id="startScanButton">바코드 스캔 시작</button>
<button id="stopScanButton" style="display:none; background-color:#e67e22;">스캔 중지</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="scanStatus">스캔 대기 중...</div>

<table>
    <thead>
        <tr>
            <th>상품명</th>
            <th>수량</th>
            <th>바코드</th>
            <th>삭제</th>
        </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
</table>

<!-- jsQR 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];

const productNameInput = document.getElementById('productName');
const productQuantityInput = document.getElementById('productQuantity');
const productBarcodeInput = document.getElementById('productBarcode');
const addButton = document.getElementById('addButton');
const inventoryTable = document.getElementById('inventoryTable');

const startScanButton = document.getElementById('startScanButton');
const stopScanButton = document.getElementById('stopScanButton');
const scanStatus = document.getElementById('scanStatus');

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let scanning = false;
let scanInterval;
let videoStream = null;

function renderInventory() {
    inventoryTable.innerHTML = '';

    if (inventory.length === 0) {
        inventoryTable.innerHTML = `<tr><td colspan="4">등록된 상품이 없습니다.</td></tr>`;
        return;
    }

    inventory.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.barcode}</td>
            <td><button class="delete-btn" data-index="${index}">삭제</button></td>
        `;
        inventoryTable.appendChild(tr);
    });

    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', e => {
            const idx = e.target.getAttribute('data-index');
            deleteItem(idx);
        });
    });
}

function addItem() {
    const name = productNameInput.value.trim();
    const quantity = productQuantityInput.value.trim();
    const barcode = productBarcodeInput.value.trim();

    if (!name || !quantity || !barcode) {
        alert('모든 항목을 입력해주세요.');
        return;
    }
    if (isNaN(quantity) || quantity <= 0) {
        alert('수량은 1 이상의 숫자여야 합니다.');
        return;
    }

    inventory.push({ name, quantity: Number(quantity), barcode });
    localStorage.setItem('inventory', JSON.stringify(inventory));

    productNameInput.value = '';
    productQuantityInput.value = '';
    productBarcodeInput.value = '';

    renderInventory();
}

function deleteItem(index) {
    inventory.splice(index, 1);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderInventory();
}

addButton.addEventListener('click', addItem);

renderInventory();

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        scanning = true;
        scanStatus.textContent = "스캔 중...";

        scanInterval = requestAnimationFrame(scanFrame);
    } catch (e) {
        alert("카메라 권한이 필요하거나 접근에 실패했습니다: " + e.message);
    }
}

function stopCamera() {
    scanning = false;
    scanStatus.textContent = "스캔 중지";

    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    cancelAnimationFrame(scanInterval);
}

function scanFrame() {
    if (!scanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
            productBarcodeInput.value = code.data;
            scanStatus.textContent = `바코드 인식: ${code.data}`;

            if (!productNameInput.value.trim()) productNameInput.value = "스캔상품";
            if (!productQuantityInput.value.trim()) productQuantityInput.value = "1";

            addItem();
            stopScanButton.click(); // 자동 중지
            return;
        } else {
            scanStatus.textContent = "스캔 중...";
        }
    }

    scanInterval = requestAnimationFrame(scanFrame);
}

startScanButton.addEventListener('click', () => {
    startScanButton.style.display = 'none';
    stopScanButton.style.display = 'inline-block';
    startCamera();
});

stopScanButton.addEventListener('click', () => {
    stopScanButton.style.display = 'none';
    startScanButton.style.display = 'inline-block';
    stopCamera();
});
</script>

</body>
</html>
